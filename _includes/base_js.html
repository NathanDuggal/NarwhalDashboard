<script>
    var DISCONNECTED = 0;
    var CONNECTING = 1;
    var CONNECTED = 2;

    var socket;
    var state = DISCONNECTED;

    var autos = [];
    var json;

    var autoMenuVisible = false;
    var updater = null;

    var current_tab = "dashboard";

    var left_ids, right_ids;

    function setTab(id) {
        element(current_tab + '_tab').classList.remove('active');
        element(current_tab).classList.add('invisible');

        current_tab = id;

        element(current_tab + '_tab').classList.add('active');
        element(current_tab).classList.remove('invisible');
    }

    function toggleConnection() {
        if (state == DISCONNECTED) {
            connect();
        }
        else {
            state = DISCONNECTED;
            
            socket.close();
            socket = null;
        }
    }
    
    function toggleCamConnection() {
        var x = element('cameraStream')
        if (x.style.display === "none") {
            x.style.display = "block";
            element('cam_conn_button').classList.remove('red');
            element('cam_conn_button').classList.remove('orange');
            element('cam_conn_button').classList.add('green');
            setInner('cam_conn_button_text', 'Disconnect from Camera')
            element('cameraStream').src = 'limelight.local:5800' 
            // http://10.31.28.2:1181/stream.mjpg
        } else {
            x.style.display = "none";
            element('cam_conn_button').classList.remove('green');
            element('cam_conn_button').classList.remove('orange');
            element('cam_conn_button').classList.add('red');
            setInner('cam_conn_button_text', 'Connect to Camera')
            element('cameraStream').src = ''
        }
    }

    function connect() {
        //socket = new WebSocket("ws:roborio-3128-frc.local:5800");
        socket = new WebSocket("ws:10.31.28.2:5805");

        element('conn_button').classList.remove('red');
        element('conn_button').classList.remove('green');
        element('conn_button').classList.add('orange');
        setInner('conn_button_text', 'Connecting...');
        state = CONNECTING;
        
        socket.onopen = function(event) {
            console.log("Connected.")

            element('conn_button').classList.remove('red');
            element('conn_button').classList.remove('orange');
            element('conn_button').classList.add('green');
            setInner('conn_button_text', 'Connected');
            state = CONNECTED;

            element("cover").style.display = 'none';
        };

        socket.onmessage = function(event) {
            json = JSON.parse(event.data);

            if (json.hasOwnProperty('auto_programs')) {
                autos = json['auto_programs'];

                setup_auto_chooser();
            }

            if (updater != null) {
                sel_auto = json['selected_auto']
                if (sel_auto == "null") {
                    sel_auto = "None";
                }
    
                setInner('selected_auto', sel_auto);
                setInner('match_time', Number(json['time']).toFixed(0));

                updater(json);
            }
        };

        socket.onclose = function(event) {
            // TODO: If disconnected by robot (i.e. not due to user manually clicking the connection button,
            // automatically try to reconnect.)
            
            state = DISCONNECTED;

            element('conn_button').classList.remove('green');
            element('conn_button').classList.remove('orange');
            element('conn_button').classList.add('red');
            setInner('conn_button_text', 'Disconnected');

            element("cover").style.display = 'block';

            autos = [];
            setup_auto_chooser();

            element.innerHTML = "Not Connected."
        };
    }

    function addUpdater(u) {
        updater = u;
    }

    function setup_auto_chooser() {
        noneElement = element("auto_choice_none")

        element("auto_list").innerHTML = noneElement.outerHTML;

        for (var i = 0; i < autos.length; i++) {
            var element = noneElement.cloneNode(true);

            element.id = "auto_choice_" + i
            element.setAttribute('onclick', "select_auto(" + i + ")")
            element.innerHTML = autos[i]

            element("auto_list").appendChild(element);
        }
    }

    function openAutoMenu() {
        element('auto_list').style.display = 'block';
        autoMenuVisible = true;
    }

    function closeAutoMenu() {
        element('auto_list').style.display = 'none';
        autoMenuVisible = false;
    }

    function toggleAutoMenu() {
        if (!autoMenuVisible) {
            openAutoMenu();
        }
        else {
            closeAutoMenu();
        }
    }

    function select_auto(i) {
        if (i == "-1") {
            send("selectAuto:null");
        }
        else {
            send("selectAuto:" + autos[Number(i)]);
        }
        closeAutoMenu();
    }

    function buttonDown(name) {
        send("button:" + name + ":down");
    }

    function buttonUp(name) {
        send("button:" + name + ":up");
    }

    function send(string_data) {
        if (state == CONNECTED) {
            socket.send(string_data);
            console.log("Sent \'" + string_data + "\'");
        }
        else {
            console.log("Attempted to send \'" + string_data + "\'");
        }
    }

    function sendNum(id, value) {
        send('numData:' + id + ':' + value)
    }

    function element(id) {
        return document.getElementById(id);
    }

    function setInner(id, innerHTML) {
        element(id).innerHTML = innerHTML;
    }
</script>